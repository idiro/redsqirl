<ui:composition xmlns="http://www.w3.org/1999/xhtml"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:a4j="http://richfaces.org/a4j"
    xmlns:rich="http://richfaces.org/rich"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:ui="http://java.sun.com/jsf/facelets">

<a4j:loadBundle basename="MessagesResources" var="messages" />
        
<script>
    var minSize = true;
    function toggleTableSize(){
        if(minSize){
            //alert("hide all: "+minSize);
            //alert("canvasModalHeader");
            jQuery("#canvasModalHeader").hide();
            jQuery('[id$="panelBtCanvasModal"]').hide();
            
            //alert("canvasModalInteractionHeader_");
            jQuery('[id^="canvasModalInteractionHeader_"]').hide();
            //alert("input");
            if(jQuery('[id$="inputInteractionRegion"]')){
                jQuery('[id$="inputInteractionRegion"]').hide();
            }
            //alert("list");
            if(jQuery('[id$="listInteractionRegion"]')){
                jQuery('[id$="listInteractionRegion"]').hide();
            }
            //alert("append");
            if(jQuery('[id$="appendListInteractionRegion"]')){
                jQuery('[id$="appendListInteractionRegion"]').hide();
            }
            //alert("browser");
            if(jQuery('[id$="browserInteractionRegion"]')){
                jQuery('[id$="browserInteractionRegion"]').hide();
            }
            //alert("text");
            if(jQuery('[id$="textEditorInteractionRegion"]')){
                jQuery('[id$="textEditorInteractionRegion"]').hide();
            }
            //alert("div");
            jQuery("#DivTableInteraction").css("height","390");
        }else{
            //alert("show all: "+minSize);
            
            //alert("canvasModalHeader");
            jQuery("#canvasModalHeader").show();
            jQuery('[id$="panelBtCanvasModal"]').show();
            //alert("canvasModalInteractionHeader_");
            jQuery('[id^="canvasModalInteractionHeader_"]').show();
            //alert("input");
            if(jQuery('[id$="inputInteractionRegion"]')){
                jQuery('[id$="inputInteractionRegion"]').show();
            }
            //alert("list");
            if(jQuery('[id$="listInteractionRegion"]')){
                jQuery('[id$="listInteractionRegion"]').show();
            }
            //alert("append");
            if(jQuery('[id$="appendListInteractionRegion"]')){
                jQuery('[id$="appendListInteractionRegion"]').show();
            }
            //alert("browser");
            if(jQuery('[id$="browserInteractionRegion"]')){
                jQuery('[id$="browserInteractionRegion"]').show();
            }
            //alert("text");
            if(jQuery('[id$="textEditorInteractionRegion"]')){
                jQuery('[id$="textEditorInteractionRegion"]').show();
            }
            //alert("div");
            jQuery("#DivTableInteraction").css("height","220px");
        }
        minSize= !minSize;
        //alert("new value: "+minSize);
    }
    
</script>
        
<h:form>
        
    <div id="domMessageDivModal" style="display: none;">
        <img src="../image/icons/waiting.gif" />
    </div>
        
    <a4j:region>
        <a4j:jsFunction name="closeDynamicForm" oncomplete="#{rich:component('canvasModalPanel')}.hide();updateOutputStatus('#{canvasModalBean.idGroup}');" />
    </a4j:region>

    <a4j:region>
        <a4j:status onstart="jQuery.blockUI({ message: jQuery('#domMessageDivModal') });"
                    onerror="jQuery.unblockUI();" onsuccess="jQuery.unblockUI();"
                    onstop="jQuery.unblockUI();" />
                    
        <a4j:jsFunction name="openModalOutputBrowser"
            reRender="modalOutputBrowser" oncomplete="#{rich:component('modalOutputBrowser')}.show()">
        </a4j:jsFunction>
    </a4j:region>
    
            
    <div style="width:100%; overflow: auto; height: 550px;" >
                
        <rich:tabPanel id="canvasModalTabPanel"  style="border:none;" switchType="ajax" selectedTab="#{canvasModalBean.selectedTab}" >
        
                <a4j:status onstart="jQuery.blockUI({ message: jQuery('#domMessageDivModal') });"
                    onerror="jQuery.unblockUI();" onsuccess="jQuery.unblockUI();"
                    onstop="jQuery.unblockUI();" />
        
        <rich:tab id="confTabCM" label="#{messages.label_dynamic_configuration}" style="border:none;border-collapse:collapse;" >
        <rich:panel id="panelDynamicForm" style="border:none;min-height: 465px;" >
            
            <span id="canvasModalHeader">
            
                <table style="width:100%;display:block;">
                    <tbody style="width:100%">
                        <tr style="width:100%;right:0px;position:relative;">
                            <td style="width:50px;padding:0px;margin:0px;" >
                                <img src="#{canvasModalBean.pathImage}"/>
                            </td>
                            <td style="width:700px;padding:0px;margin:0px;">
                                <h1><h:outputText value="#{canvasModalBean.pageTitle}"/></h1>
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <p>
                	<h:graphicImage value="../image/icons/question_mark.jpg" title='#{canvasModalBean.pageTextTip}' styleClass="questionMarkIcon" rendered="#{canvasModalBean.pageTextTip != null}" />
                	<h:outputText value="#{canvasModalBean.pageLegend}"/>
                </p>
            
            </span>
        
            <a4j:repeat value="#{canvasModalBean.inters}" var="interCur" rowKeyVar="interCurIdx" id="dynamicFormInteraction" >
                
                <span id="canvasModalInteractionHeader_#{interCurIdx}">
                    
                    <h2><h:outputText value="#{interCur.name}"/></h2>
                    
                    <p>
                    	<h:graphicImage value="../image/icons/question_mark.jpg" title='#{interCur.textTip}' styleClass="questionMarkIcon" rendered="#{interCur.textTip != null}"/>
                    	<h:outputText value="#{interCur.legend}"/>
                    </p>
                    
                </span>
                
                <!-- input -->
                <a4j:region id="inputInteractionRegion" rendered="#{interCur.displayType == 'input'}">
                    <h:inputText  value="#{interCur.input.inputValue}" maxlength="255" style="width:395px;" styleClass="interModal"
                        onkeypress="return disableEnterKey(event);"/>
                </a4j:region>     
                
                <!-- list -->
                <a4j:region id="listInteractionRegion"  rendered="#{interCur.displayType == 'list'}">
                    <rich:comboBox value="#{interCur.list.selectedListOption}" selectFirstOnUpdate="false" width="200" 
                        listWidth="150" listHeight="200" enableManualInput="false" rendered="#{interCur.list.comboBox == 'Y'}" >
                        <f:selectItems value="#{interCur.list.listOptions}" />
                    </rich:comboBox>
                    
                    <h:selectOneRadio value="#{interCur.list.selectedListOption}" rendered="#{interCur.list.comboBox == 'N'}" layout="pageDirection" >
                        <f:selectItems value="#{interCur.list.listOptions}" />
                    </h:selectOneRadio>
                </a4j:region>
                <!-- appendList -->
                <a4j:region id="appendListInteractionRegion" rendered="#{interCur.displayType == 'appendList'}">
                    <rich:pickList
                        copyAllControlLabel="Select all"
                        copyControlLabel="Select"
                        removeAllControlLabel="Unselect all"
                        removeControlLabel="Unselect"
                        value="#{interCur.appendList.selectedAppendListOptions}" 
                        rendered="#{interCur.appendList.comboBox == 'Y'}" >
                        <f:selectItems value="#{interCur.appendList.appendListOptions}" />
                    </rich:pickList>
                    
                    <h:selectManyCheckbox value="#{interCur.appendList.selectedAppendListOptions}" rendered="#{interCur.appendList.comboBox == 'N'}" layout="pageDirection" >
                        <f:selectItems value="#{interCur.appendList.appendListOptions}" />
                    </h:selectManyCheckbox>
                </a4j:region>
                <!-- browser -->
                <a4j:region id="browserInteractionRegion" rendered="#{interCur.displayType == 'browser'}">
                    <rich:panel style="border:none;" id="browserPanel" >
                    
                        <h:outputText value="#{messages.label_path}" />
                        <br/>
                        <h:inputText id="browserPath" label="Path" value="#{interCur.browser.path}" maxlength="255" 
                            style="width:395px;" styleClass="interModal" onclick="openModalOutputBrowser();" />
            
                        <br/><br/>
                        
                        <div id="browserProperties" style="width:100%; height:70px;  border:1px solid black; overflow-x: hidden;">
                        
                            <rich:extendedDataTable id="browserTableProp" value="#{interCur.browser.listProperties}"
                                var="property" width="100%" style="border:none;" onRowMouseOver="this.style.backgroundColor='#F1F1F1'"
                                enableContextMenu="false" selectionMode="none" rowKeyVar="index"
                                onRowMouseOut="this.style.backgroundColor='#{a4jSkin.rowBackgroundColor}'"
                                rowClasses="even-row, odd-row" >
                                
                                <rich:column id="browserPropLabel" >
                                    <f:facet name="header">
                                        <h:outputText value="#{messages.label_properties}" />
                                    </f:facet>
                                    <h:inputText styleClass="interModal" value="#{property.label}" style="border:none !important;width:95%;" readonly="true" onclick="setPropValueFocus(#{index});" />
                                </rich:column>
                                <rich:column id="browserPropValue" >
                                    <f:facet name="header">
                                        <h:outputText value="#{messages.label_value}" />
                                    </f:facet>
                                    <h:inputText id="browserPropValueInput" styleClass="interModal" value="#{property.value}" style="border:none !important;width:95%;" />
                                </rich:column>
                
                            </rich:extendedDataTable>
                        
                        </div>
                        
                        <br/>
                        
                        <div id="divBrowserData" style="width:100%; height:120px;  border:1px solid black; overflow-x: hidden;">
                        
                            <rich:scrollableDataTable id="browserTableData" value="#{interCur.browser.gridRows}" height="100%"
                                var="rowData" index="rowDataIndex" width="100%" style="border:none;" onRowMouseOver="this.style.backgroundColor='#F1F1F1'"
                                enableContextMenu="false"
                                onRowMouseOut="this.style.backgroundColor='#{a4jSkin.rowBackgroundColor}'"
                                rowClasses="even-row, odd-row" >
                       
                                <rich:columns value="#{canvasModalBean.outputTab.titles == null? canvasBean.emptyList : canvasModalBean.outputTab.titles}" 
                                              var="column" 
                                              index="ind"
                                              id="column#{ind}"
                                              sortExpression="#{rowData[ind]}">
                                    
                                    <f:facet name="header">
                                        <h:outputText value="#{column}" />
                                    </f:facet>
                                    
                                    <h:outputText value="#{rowData[ind]}" />
                                    
                                </rich:columns>
                
                            </rich:scrollableDataTable>
                
                        </div>
                        
                    </rich:panel>
                </a4j:region>
                
                <!-- helpTextEditor -->
                <a4j:region id="textEditorInteractionRegion" rendered="#{interCur.displayType == 'helpTextEditor'}">
                    <rich:panel style="border:none;" id="helpTextEditorPanel" >
                        <h:outputText value="#{messages.label_formula}" />
                        <br/>
                        
                        <h:inputTextarea maxlength="100" cols="90" rows="10" value="#{interCur.editor.textEditorValue}" 
                        	style="resize:none;border:1pxsolid;width:85%;" id="command">
                        	
                       		<a4j:commandButton action="#{canvasModalBean.openHelpTextEditorModal}" value=". . ."  
	                        	reRender="commandText,listFields,listFunctions,listCategories,listOperation,listCategoriesOperation" 
	                            oncomplete="#{rich:component('textEditorPanel')}.show()" style="float:right;margin-right:62px;height:46px;" 
	                            rendered="#{interCur.editor.openPopup == 'Y'}">
	                            <a4j:actionparam name="idInteraction" value="#{interCur.id}"/>
							</a4j:commandButton>
                            
                        </h:inputTextarea>
                        
                        <br/>
                        <br/>
                    </rich:panel>
                </a4j:region>
                
                <!-- table -->
                <a4j:region id="tableInteractionRegion" rendered="#{interCur.displayType == 'table'}">
                    <rich:panel style="border:none;" id="tablePanel">
                        
        
                        <h:panelGrid id="table" columns="3" rendered="#{!empty interCur.table.tableGeneratorMenu}">
                        <h:outputText value="#{messages.label_generation}" />
                            <rich:comboBox
                                value="#{interCur.table.selectedGenerator}" width="200"
                                enableManualInput="false" id="generation" listWidth="150"
                                listHeight="200">
                                <f:selectItems styleClass="interModal" value="#{interCur.table.tableGeneratorMenu}" />
                            </rich:comboBox>
    
                            <a4j:commandButton type="submit"
                                styleClass="greenButton"    
                                id="tableInteractionGenerationLines"
                                action="#{interCur.table.generateLines}"
                                value="#{messages.button_ok}" reRender="tableInteraction">
                            </a4j:commandButton>
                            
                        </h:panelGrid>
                        <a4j:commandLink
                            title="Add new line"
                            action="#{interCur.addNewLine}"
                            reRender="tableInteraction">
                            <img id="tableInteractionBtAdd"
                                src="../image/icons/button-plus.gif" />
                        </a4j:commandLink>
                        <a4j:commandLink
                            style="float:right;"
                            title="Resize"
                            onclick="toggleTableSize();">
                            <img id="tableInteractionBtResize"
                                src="../image/icons/resize-6-24.gif" />
                        </a4j:commandLink>
                        <div id="DivTableInteraction" style="width:100%; height: 220px; border: 1px solid grey; overflow-x: hidden;">
                            
                            <rich:dataTable id="tableInteraction" value="#{interCur.table.tableGridRows}"
                                var="rowItem" rowKeyVar="rowNb" width="100%" style="border:none;" 
                                onRowMouseOver="this.style.backgroundColor='#F1F1F1'"
                                enableContextMenu="false" 
                                onRowMouseOut="this.style.backgroundColor='#{a4jSkin.tableBackgroundColor}'" >
        
                                <rich:column style="border-bottom:0px;border-right:0px;"
                                    width="20px;">
                                    <h:outputText value="#{rowNb+1}" />
                                </rich:column>
        
                                <rich:column style="border-bottom:0px;border-right:0px;"
                                    width="40px;">
                                    <f:facet name="header">
                                        <h:panelGrid columns="1" styleClass="">
                                        <a4j:commandLink
                                            title="Delete selected lines"
                                            action="#{interCur.table.deleteLine}"
                                            reRender="tableInteraction"
                                            onclick="if(!confirm('Are you sure you want to delete the selected line?')){return false;}">
                                            <img id="tableInteractionBtDelete"
                                                src="../image/icons/button-delete2.gif" />
                                        </a4j:commandLink>
                                        <h:selectBooleanCheckbox onclick="selectAllCheckbox(this, /tableInteractionSelect$/);"/>
                                        </h:panelGrid>
                                    </f:facet>
        
                                    <h:selectBooleanCheckbox id="tableInteractionSelect" value="#{rowItem.selected}">
                                        <f:selectItem itemValue="true" />
                                    </h:selectBooleanCheckbox>
        
                                </rich:column>
                                
                                <rich:columns value="#{canvasModalBean.tablesColumnTitle == null? canvasBean.emptyList : canvasModalBean.tablesColumnTitle}"
                                    var="column" index="ind"
                                    style="border-bottom:0px;border-right:0px;">
                                    <f:facet name="header">
                                        <h:outputText value="#{column}" />
                                    </f:facet>
        
                                    <h:inputText value="#{rowItem.row[ind]}"
                                        rendered="#{interCur.table.columnType[column] == 'textField' }"
                                        styleClass="tableInteractionInput"
                                        onkeypress="return disableEnterKey(event);"/>
        
                                    <rich:comboBox value="#{rowItem.row[ind]}"
                                        selectFirstOnUpdate="false" defaultLabel="Enter some value"
                                        width="125" enableManualInput="true" listWidth="150"
                                        listHeight="150"
                                        rendered="#{interCur.table.columnType[column] == 'comboBox' }"
                                        styleClass="tableInteractionInput">
                                        <f:selectItems value="#{interCur.table.tableConstraints[column]}" />
                                    </rich:comboBox>
        
									<h:inputText value="#{rowItem.row[ind]}" 
									       rendered="#{interCur.columnType[column] == 'editor' }" 
									       styleClass="tableInteractionTextEditor" >
                                   	<a4j:commandButton action="#{canvasModalBean.openHelpTextEditorModal}" value="..." style="float:right;width:15%;" 
                                   		reRender="commandText,listFields,listFunctions,listCategories,listOperation,listCategoriesOperation,command,tableInteraction" 
                                   		oncomplete="#{rich:component('textEditorPanel')}.show()">
                                   		<a4j:actionparam  name="idInteraction" value="#{interCur.id}"/>
                                           <a4j:actionparam  name="rowKey" value="#{rowNb}"/>
                                           <a4j:actionparam  name="column" value="#{column}"/>
									</a4j:commandButton>
									</h:inputText>	        								
        
                                </rich:columns>
        
                            </rich:dataTable>
                            
                            </div>
                        
                    </rich:panel>
                </a4j:region>
            </a4j:repeat>
            
            
        </rich:panel>
            
            <br/>
        
            <rich:panel id="panelBtCanvasModal" style="border:none; float:right;" >
            
                <a4j:commandButton styleClass="greenButton" value="#{messages.button_cancel}" onclick="closeDynamicForm();" reRender="panelBtCanvasModal, msnError, errorTable" />
                
                <a4j:commandButton action="#{canvasModalBean.previousPage}" styleClass="greenButton" value="#{messages.button_previous}" rendered="#{canvasModalBean.firstPage == 'N'}" reRender="panelDynamicForm, panelBtCanvasModal, browserPanel, msnError" oncomplete="changeHelpAnchor('#{canvasModalBean.listPosition}');" />
                
                <a4j:commandButton action="#{canvasModalBean.applyPage}" styleClass="greenButton" value="#{messages.button_apply}" reRender="panelDynamicForm, panelBtCanvasModal, browserPanel, msnError, canvasModalTabPanel, browserTableProp, browserTableData, browserPropLabel, browserPropValue" oncomplete="changeHelpAnchor('#{canvasModalBean.listPosition}');" />
    
                <a4j:commandButton action="#{canvasModalBean.nextPage}" styleClass="greenButton" value="#{messages.button_next}" rendered="#{canvasModalBean.lastPage == 'N'}" reRender="panelDynamicForm, panelBtCanvasModal, browserPanel, browserTableData, msnError" oncomplete="changeHelpAnchor('#{canvasModalBean.listPosition}');" />
                
                <a4j:commandButton action="#{canvasModalBean.applyPage}" oncomplete="if(#{requestScope['msnError'] == null} )closeDynamicForm();" styleClass="greenButton" value="#{messages.button_ok}" rendered="#{canvasModalBean.lastPage == 'Y'}" reRender="msnError, errorTable" />
            
            </rich:panel>
        
         </rich:tab>
            
            <rich:tab id="outputTab" label="#{messages.label_dynamic_data}" rerender="dataOutputForm,dataDisplayReg,titleDisplay,displayTableDiv" rendered="#{canvasModalBean.outputTab.showOutputForm == 'Y'}" >
                
                <rich:panel id="dataOutputForm" style="min-height:465px;border:none;">
                    <a4j:repeat value="#{canvasModalBean.outputTab.outputFormList}" var="item"
                        rowKeyVar="index">
                        <h:panelGrid columns="6">
                            <a4j:commandLink value="output #{item.name}" 
                                             action="#{canvasModalBean.outputTab.displayOutput}" 
                                             reRender="dataDisplayReg,titleDisplay,displayTableDiv">
                                <a4j:actionparam name="outputName" value="#{item.name}" />
                            </a4j:commandLink>
                            <rich:comboBox id="outputCombo" selectFirstOnUpdate="false"
                                width="200" value="#{item.savingState}" listWidth="150"
                                listHeight="200" enableManualInput="false">
                                <f:selectItems value="#{item.savingStateList}" />
                                <a4j:support event="onchange" reRender="dataOutputForm" />
                            </rich:comboBox>
                            
                            <a4j:commandButton value="Select" styleClass="greenButton"
                                rendered="#{item.renderBrowserButton}"
                                oncomplete="openModalOutputBrowser()">
                                <a4j:actionparam name="nameOutput" value="#{item.name}"
                                    assignTo="#{canvasModalBean.outputTab.nameOutput}" />
                            </a4j:commandButton>
                            
                            <h:outputText value="#{item.path}"/>
                            
                            <h:inputText  styleClass="interModal" value="#{item.file}" maxlength="40" style="width:100px;" rendered="#{item.renderBrowserButton}"/>
                                
                            <a4j:commandButton value="#{messages.button_remove}" action="#{canvasModalBean.outputTab.removeData}"  styleClass="greenButton" >
                                <a4j:actionparam name="nameOutputClean" value="#{item.name}" />
                            </a4j:commandButton>
                                
                        </h:panelGrid>
                    </a4j:repeat>
                    
                    
                <!-- display data -->
                <a4j:region style="border:none;"  id="dataDisplayReg">
                
                        <h:outputText  value="#{canvasModalBean.outputTab.nameOutput}" id="titleDisplay" rendered="#{canvasModalBean.outputTab.titles != null}"/>
                        <br/>
                        <div id="displayTableDiv" style="width:100%; height:240px; border:1px solid black; overflow-x: hidden;">
                        
                        
                            <rich:scrollableDataTable id="displayTable" value="#{canvasModalBean.outputTab.rows}" height="100%"
                                var="rowData" index="rowDataIndex" width="100%" style="border:none;" onRowMouseOver="this.style.backgroundColor='#F1F1F1'"
                                enableContextMenu="false"
                                onRowMouseOut="this.style.backgroundColor='#{a4jSkin.rowBackgroundColor}'"
                                rowClasses="even-row, odd-row" >
                       
                                <rich:columns value="#{canvasModalBean.outputTab.titles == null? canvasBean.emptyList : canvasModalBean.outputTab.titles}" 
                                              var="column" 
                                              index="ind"
                                              id="column#{ind}"
                                              sortExpression="#{rowData[ind]}">
                                    
                                    <f:facet name="header">
                                        <h:outputText value="#{column}" />
                                    </f:facet>
                                    
                                    <h:outputText value="#{rowData[ind]}" title="#{rowData[ind]}" />
                                    
                                </rich:columns>
                
                            </rich:scrollableDataTable>
                
                        </div>
                </a4j:region>
    
                </rich:panel>
                
                    <rich:panel columns="3" style="border:none; float:right;">
                        <a4j:commandButton styleClass="greenButton" value="#{messages.button_cancel}" onclick="closeDynamicForm();" reRender="panelBtCanvasModal, msnError, errorTable" />
                        <a4j:commandButton value="#{messages.button_apply}"  styleClass="greenButton" action="#{canvasModalBean.outputTab.confirmOutput}" />
                        <a4j:commandButton value="#{messages.button_ok}"  styleClass="greenButton" action="#{canvasModalBean.outputTab.confirmOutput}" oncomplete="#{rich:component('canvasModalPanel')}.hide();updateOutputStatus('#{canvasModalBean.idGroup}')"/>
                    </rich:panel>
                
                
                
            </rich:tab>
        </rich:tabPanel>
        
    </div>
    
    </h:form>
            
            <rich:modalPanel id="modalOutputBrowser" width="600" height="400" style="overflow:hidden;" resizeable="false">
    
                <f:facet name="header">Browser</f:facet>
                <f:facet name="controls">
                    <h:graphicImage value="../image/icons/buttonCloseWindow.gif" style="cursor:pointer;width:22px;"
                        onclick="#{rich:component('modalOutputBrowser')}.hide()" />
                </f:facet>
        
                <h:form>
                    <h:panelGroup>
                        <a4j:include viewId="/pages/modalOutputBrowser.xhtml" ajaxRendered="true" />
                    </h:panelGroup>
                </h:form>
        
            </rich:modalPanel>

            <rich:modalPanel id="textEditorPanel" width="650" height="420" style="overflow:hidden;" >
                    
                    <f:facet name="header">Editor</f:facet>
                    <f:facet name="controls">
                        <h:graphicImage value="../image/icons/buttonCloseWindow.gif"
                            style="cursor:pointer;width:22px;"
                            onclick="#{rich:component('textEditorPanel')}.hide()" />
                    </f:facet>
                    
                    <h:panelGroup>
                        <ui:include src="/pages/canvasModalEditorPopup.xhtml" />
                    </h:panelGroup>
                    
            </rich:modalPanel>
    
</ui:composition>

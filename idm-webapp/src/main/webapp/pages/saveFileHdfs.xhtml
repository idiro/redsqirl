<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:a4j="http://richfaces.org/a4j"
	xmlns:rich="http://richfaces.org/rich"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets">

<a4j:loadBundle basename="MessagesResources" var="messages" />

<script>
//<![CDATA[
           
	var file;
	
	function getPath(p){
		if (!file){
			return p;
		}
		return p + "/"+ file;
	}
	
	function changeFile(f){
		file = f;
	}
	
	function verifyIfFileExists(path){
		
		var fileExist = false;
		
		var table = jQuery('#divSaveFileHdfs table.extdt-table-layout');
		var tbody = table.find("tbody");
		var rows = tbody.find("tr");

        rows.each(function(key, value){
        	var file2 = jQuery(this).find("td a").html();
        	if ((file == file2) || (file+'.rs' == file2)){
        		fileExist = true;
        	}
        });
		
		if (fileExist){
			Richfaces.showModalPanel('modalConfirmOverwrite');
		}
		else{
			Richfaces.hideModalPanel('modalSaveWorkflow');
			save(path);
		}
	}

	function selectFileSaveHdfs(isFile, nameFile){
    	if (isFile != "true"){
        	updateTableSaveHdfs(nameFile);
    	}
    }
	
//]]>
</script>

	<a4j:status	onstart="jQuery.blockUI({ message: jQuery('#domMessageDivModal') });"
		onerror="jQuery.unblockUI();" onsuccess="jQuery.unblockUI();"
		onstop="jQuery.unblockUI();" />
		
	<a4j:jsFunction name="updateTableSaveHdfs" action="#{browserHdfsBean.selectFile}"  reRender="pathSaveFile,hdfsfsSaveFile,hdfsSaveFileBtn" >
		<a4j:actionparam name="nameFile" />
	</a4j:jsFunction>

	<h:outputText value="#{messages.label_path}" />
	<h:inputText id="pathSaveFile" label="Path" value="#{browserHdfsBean.path}"
		maxlength="255" style="width:395px;" onkeypress="return enableEnterKey(event, 'changePathSaveHdfsBtn');"/>
	
	<a4j:commandLink id="changePathSaveHdfsBtn" action="#{browserHdfsBean.changePath}" reRender="hdfsfsSaveFile,hdfsSaveFileBtn">
		<h:graphicImage value="../image/icons/button-search.gif" title='#{messages.filesystem_change_path}' />
	</a4j:commandLink>
	
	<a4j:commandLink action="#{browserHdfsBean.goPrevious}"
		reRender="pathSaveFile,hdfsfsSaveFile,hdfsSaveFileBtn">
		<h:graphicImage id="btPrev" value="../image/icons/button-previous.gif" title='#{messages.HdfsInterface_previous_help}'/>
	</a4j:commandLink>
	
	<a4j:commandLink action="#{browserHdfsBean.goNext}" reRender="pathSaveFile,hdfsfsSaveFile,hdfsSaveFileBtn">
		<h:graphicImage id="btNext" value="../image/icons/button-next.gif" title='#{messages.HdfsInterface_next_help}' />
	</a4j:commandLink>
	
	<a4j:commandLink action="#{browserHdfsBean.goUp}" reRender="pathSaveFile,hdfsfsSaveFile,hdfsSaveFileBtn">
		<h:graphicImage id="browserHdfsBeanGoUp" value="../image/icons/button_up.jpg" title='#{messages.hdfs_goup}' styleClass="fileSystemIcon" />
	</a4j:commandLink>

	<br/><br/>

	<h:outputText value="#{messages.label_file_name}" />
	<h:inputText id="nameSaveFile" label="Name" onchange="changeFile(this.value)"
		maxlength="255" style="width:395px;" onkeypress="return enableEnterKey(event, 'hdfsSaveFileBtn');"/>

	<br/><br/>

	<div id="divSaveFileHdfs" style="width:590px;height:265px;overflow: auto;" >

		<rich:extendedDataTable id="hdfsfsSaveFile" value="#{browserHdfsBean.tableGrid.rows}" var="item" rowKeyVar="indexTable" width="50px" height="10px"
			onRowMouseOver="this.style.backgroundColor='#F1F1F1'" enableContextMenu="false" selectionMode="none"
			onRowMouseOut="this.style.backgroundColor='#{a4jSkin.rowBackgroundColor}'" rowClasses="even-row, odd-row">
			
			<rich:column style="border-bottom:0px;border-right:0px;" width="50px;">
				<f:facet name="header">
					<h:outputText value="" />
				</f:facet>
					<h:graphicImage value="../image/icons/button-property.gif" title='#{messages.HdfsInterface_properties_help}' 
					rendered="#{browserHdfsBean.allProps[indexTable]['type'] == 'directory'}" styleClass="fileSystemIcon" />
					<h:graphicImage value="../image/icons/button-file-icon.png" title='#{messages.HdfsInterface_properties_help}' 
					rendered="#{browserHdfsBean.allProps[indexTable]['type'] == 'file'}" styleClass="fileSystemIcon" />
			</rich:column>
	
			<rich:column sortBy="#{browserHdfsBean.allProps[indexTable]['name']}" filterBy="#{browserHdfsBean.allProps[indexTable]['name']}"
				style="border-bottom:0px;border-right:0px;">
				<f:facet name="header">
					<h:outputText value="#{messages.label_name}" />
				</f:facet>
				<a4j:commandLink id="saveFileNameId" value="#{browserHdfsBean.allProps[indexTable]['name']}" 
					action="#{browserHdfsBean.verifyIfIsFile}" oncomplete="selectFileSaveHdfs('#{browserHdfsBean.file}', '#{browserHdfsBean.allProps[indexTable]['name']}')" >
					<f:param name="nameFile" value="#{browserHdfsBean.allProps[indexTable]['name']}" />
				</a4j:commandLink>
			</rich:column>
	
			<rich:columns value="#{browserHdfsBean.tableGrid.titles == null? canvasBean.emptyList : browserHdfsBean.tableGrid.titles}" var="column" index="ind" begin="1"
				style="border-bottom:0px;border-right:0px;">
				<f:facet name="header">
					<h:outputText value="#{column}" />
				</f:facet>
				<h:outputText value="#{item.row[ind]}" />
			</rich:columns>
	
		</rich:extendedDataTable>
	
	</div>
	
	<br/>

	<a4j:commandButton id="hdfsSaveFileBtn" value="#{messages.button_ok}" styleClass="greenButton"
		onclick="verifyIfFileExists(getPath('#{browserHdfsBean.path}'));"
		oncomplete="" reRender="errorTable" >
	</a4j:commandButton>
	
	<a4j:commandButton value="#{messages.button_cancel}" styleClass="greenButton"
		onclick="#{rich:component('modalSaveWorkflow')}.hide();"
		oncomplete="onHideModalSaveWorkflow(false);">
	</a4j:commandButton>
	
	<rich:modalPanel id="modalConfirmOverwrite" width="300" height="90"
			style="overflow:auto;" resizeable="false">

			<f:facet name="header">Overwrite file?</f:facet>
			<f:facet name="controls">
				<h:graphicImage value="../image/icons/buttonCloseWindow.gif"
					style="cursor:pointer;width:22px;"
					onclick="#{rich:component('modalConfirmOverwrite')}.hide()" />
			</f:facet>

			<h:panelGroup>
			
				<h:outputText value="#{messages.file_already_exists}" />
				<br />
				<a4j:commandButton value="#{messages.button_ok}" styleClass="greenButton"
					onclick="#{rich:component('modalConfirmOverwrite')}.hide();#{rich:component('modalSaveWorkflow')}.hide();save(getPath('#{browserHdfsBean.path}'));"
					oncomplete="" reRender="errorTable" >
				</a4j:commandButton>
				
				<a4j:commandButton value="#{messages.button_cancel}" styleClass="greenButton"
					onclick="#{rich:component('modalConfirmOverwrite')}.hide();">
				</a4j:commandButton>
			</h:panelGroup>

		</rich:modalPanel>
	
</ui:composition>
